   [DEBUG] Building queries for current and previous quarters...
   [DEBUG] data_current count: 1281
   [DEBUG] data_prev count: 1282
   [DEBUG] BEFORE JOIN - Checking reporting_cluster distribution:
   [DEBUG] data_current reporting_cluster distribution:
   [DEBUG] data_prev reporting_cluster distribution:
   [DEBUG] BEFORE JOIN - bu_level rows in data_current: 578
   [DEBUG] BEFORE JOIN - bu_level rows in data_prev: 578
   [DEBUG] Sample bu_level row in data_current (IT):
     - business_unit: IT
     - metric_final_name: 1_Activation (Paid + Referrals) - 1_Checkout Funnel - 1_PaymentPageVisitToSuccess
     - dimension_name: _Overall
     - dimension_value: None
     - current_metric_value_numerator: 7053.0
     - current_metric_value_denominator: 25517.0
   [DEBUG] Sample bu_level row in data_prev (IT):
     - business_unit: IT
     - metric_final_name: 1_Activation (Paid + Referrals) - 1_Checkout Funnel - 1_PaymentPageVisitToSuccess
     - dimension_name: _Overall
     - dimension_value: None
     - flag_more_is_good: TRUE
     - flag_is_p0: TRUE
     - metric_type: ratio
     - current_metric_value_numerator: 3099.0
     - current_metric_value_denominator: 15407.0
   [DEBUG] Comparing join keys for IT:
     - business_unit match: True
     - metric_final_name match: True
     - dimension_name match: True
     - dimension_value match: True (current: None, prev: None)
     - flag_more_is_good match: True
     - flag_is_p0 match: True
     - metric_type match: True
   [DEBUG] BEFORE JOIN - data_current_clean count: 1281
   [DEBUG] BEFORE JOIN - data_prev_selected count: 1282
   [DEBUG] Performing LEFT JOIN on columns: ['reporting_cluster', 'business_unit', 'metric_final_name', 'dimension_name', 'dimension_value', 'flag_more_is_good', 'flag_is_p0', 'metric_type']
   [DEBUG] AFTER JOIN - data_combined count: 1281
   [DEBUG] AFTER JOIN - bu_level rows in data_combined: 578
   [DEBUG] BEFORE fillna - bu_level rows with NULL prev_metric_value_numerator: 0
   [DEBUG] BEFORE fillna - bu_level rows with NULL prev_metric_value_denominator: 0
   [DEBUG] Sample bu_level row (IT) before fillna:
     - current_metric_value_numerator: 8426.0
     - current_metric_value_denominator: 9502.0
     - prev_metric_value_numerator: 4119.0
     - prev_metric_value_denominator: 4460.0
     - business_unit: IT
     - metric_final_name: 3_Active - 1_2_Loyalty: LL0 (Initial charges) - 2_PreDunningAR
   [DEBUG] AFTER PROCESSING - bu_level rows in quarter_prev_processed: 578
   [DEBUG] AFTER PROCESSING - reporting_cluster distribution:
bu_level        578
HF-INTL          71
INTL-mature      71
Overall          71
WL               71
HF-TOTAL         71
RTE              70
INTL-growing     70
HF-NA            70
INTL-startup     69
US-HF            69
Name: reporting_cluster, dtype: int64
   [DEBUG] AFTER PROCESSING - test_metric_df count: 44
   [DEBUG] AFTER PROCESSING - bu_level rows for 1_Activation (Paid + Referrals) - 1_Checkout Funnel - 1_PaymentPageVisitToSuccess: 34
   [DEBUG] Sample bu_level business units: ['FR', 'AT', 'NL', 'NZ', 'US', 'BE', 'ES', 'CA', 'DK', 'TZ']

================================================================================
[DEBUG METRIC FILTERING] Processing metric: 1_Activation (Paid + Referrals) - 1_Checkout Funnel - 1_PaymentPageVisitToSuccess
================================================================================
[DEBUG] BEFORE FILTERING - quarter_prev_processed shape: (1281, 23)
[DEBUG] BEFORE FILTERING - Unique metric_final_name values (first 10):
[DEBUG] BEFORE FILTERING - Checking if our metric exists in quarter_prev_processed:
[DEBUG] BEFORE FILTERING - Metric exists: True
[DEBUG] BEFORE FILTERING - Matching rows count: 44
[DEBUG] BEFORE FILTERING - reporting_cluster distribution in matching rows:
[DEBUG] BEFORE FILTERING - bu_level rows in matching: 34
[DEBUG] AFTER FILTERING - quarter_prev_metric:
[DEBUG] AFTER FILTERING - quarter_prev_metric shape: (44, 23)
[DEBUG] AFTER FILTERING - reporting_cluster values: ['HF-NA' 'WL' 'INTL-startup' 'HF-TOTAL' 'RTE' 'INTL-growing' 'US-HF'
 'INTL-mature' 'Overall' 'HF-INTL' 'bu_level']
[DEBUG] AFTER FILTERING - reporting_cluster distribution:
[DEBUG] AFTER FILTERING - bu_level rows in quarter_prev_metric: 34
[DEBUG] AFTER FILTERING - Sample business units: ['FR', 'AT', 'NL', 'NZ', 'US', 'BE', 'ES', 'CA', 'DK', 'TZ']
[DEBUG] AFTER FILTERING - Sample relative_change_pct: [7.273658690981051, 9.611133539136576, 20.57101005075078, 1.0290969722604506, 2.136956103508311, 15.118296155861147, 1.4218497742272045, 7.983763699481505, 12.608456236208433, -7.992516716220075]

[DEBUG Week vs Prev Week - Level 2 BU] Processing reporting cluster: HF-NA
[DEBUG] week_prev_df shape: (44, 23)
[DEBUG] week_prev_df reporting_cluster values: ['INTL-startup' 'Overall' 'RTE' 'INTL-growing' 'US-HF' 'HF-NA'
 'INTL-mature' 'HF-INTL' 'WL' 'HF-TOTAL' 'bu_level']
[DEBUG] week_prev_df business_unit sample: ['Null', 'Null', 'Null', 'Null', 'Null', 'Null', 'Null', 'Null', 'Null', 'Null']
[DEBUG] Business units in HF-NA from country_mapping_df: 2 (['CA', 'US']...)
[DEBUG] level2_bu_rows count after filtering by business_unit.isin(rc_bu): 2
[DEBUG] level2_bu_rows reporting_cluster values: ['bu_level']
[DEBUG] level2_bu_rows business_unit values: ['US' 'CA']
[DEBUG] level2_bu_rows sample relative_change_pct: [-7.673338091378426, 4.931470138420062]
[DEBUG] After calculating abs_rel_change and volume_impacted
[DEBUG] Sample abs_rel_change: [7.673338091378426, 4.931470138420062]
[DEBUG] Sample volume_impacted: [2724.495422724824, 593.3544870547018]
[DEBUG] After filtering (abs_rel_change>10 OR volume_impacted>30): 2 rows
[DEBUG] Significant business units for HF-NA: ['US', 'CA']

[DEBUG Week vs Prev Week - Level 2 BU] Processing reporting cluster: HF-INTL
[DEBUG] week_prev_df shape: (44, 23)
[DEBUG] week_prev_df reporting_cluster values: ['INTL-startup' 'Overall' 'RTE' 'INTL-growing' 'US-HF' 'HF-NA'
 'INTL-mature' 'HF-INTL' 'WL' 'HF-TOTAL' 'bu_level']
[DEBUG] week_prev_df business_unit sample: ['Null', 'Null', 'Null', 'Null', 'Null', 'Null', 'Null', 'Null', 'Null', 'Null']
[DEBUG] Business units in HF-INTL from country_mapping_df: 16 (['AT', 'AU', 'BE', 'CH', 'DE', 'DK', 'ES', 'FR', 'GB', 'IE']...)
[DEBUG] level2_bu_rows count after filtering by business_unit.isin(rc_bu): 16
[DEBUG] level2_bu_rows reporting_cluster values: ['bu_level']
[DEBUG] level2_bu_rows business_unit values: ['IT' 'CH' 'DE' 'NO' 'IE' 'AU' 'NL' 'DK' 'FR' 'AT' 'ES' 'NZ' 'SE' 'GB'
 'LU' 'BE']
[DEBUG] level2_bu_rows sample relative_change_pct: [-11.794620965567416, -10.42775478020895, -4.4138648177885305, -13.631940530250667, 0.4745803026303691, 0.7716935706674032, -0.9775449081807459, -4.124455796982651, -1.728568291453654, 0.3138366916690508]
[DEBUG] After calculating abs_rel_change and volume_impacted
[DEBUG] Sample abs_rel_change: [11.794620965567416, 10.42775478020895, 4.4138648177885305, 13.631940530250667, 0.4745803026303691, 0.7716935706674032, 0.9775449081807459, 4.124455796982651, 1.728568291453654, 0.3138366916690508]
[DEBUG] Sample volume_impacted: [133.39716312056748, 35.662921348314605, 510.9489913072003, 165.21911922663807, 12.571632216678477, 45.12092307692306, 20.293832293832285, 63.80533117932161, 266.73537305421337, 3.125813449023746]
[DEBUG] After filtering (abs_rel_change>10 OR volume_impacted>30): 10 rows
[DEBUG] Significant business units for HF-INTL: ['DE', 'FR', 'GB', 'NO', 'ES', 'IT', 'DK', 'AU', 'CH', 'LU']

[DEBUG Week vs Prev Week - Level 2 BU] Processing reporting cluster: RTE
[DEBUG] week_prev_df shape: (44, 23)
[DEBUG] week_prev_df reporting_cluster values: ['INTL-startup' 'Overall' 'RTE' 'INTL-growing' 'US-HF' 'HF-NA'
 'INTL-mature' 'HF-INTL' 'WL' 'HF-TOTAL' 'bu_level']
[DEBUG] week_prev_df business_unit sample: ['Null', 'Null', 'Null', 'Null', 'Null', 'Null', 'Null', 'Null', 'Null', 'Null']
[DEBUG] Business units in RTE from country_mapping_df: 8 (['CF', 'FJ', 'TO', 'TT', 'YE', 'TV', 'TK', 'TZ']...)
[DEBUG] level2_bu_rows count after filtering by business_unit.isin(rc_bu): 8
[DEBUG] level2_bu_rows reporting_cluster values: ['bu_level']
[DEBUG] level2_bu_rows business_unit values: ['CF' 'TT' 'TO' 'FJ' 'YE' 'TZ' 'TV' 'TK']
[DEBUG] level2_bu_rows sample relative_change_pct: [16.227387138030817, -1.73315183080808, 9.179282180133509, 6.456341805367642, -1.988686799195942, 11.925564506978322, 17.83835616438357, 10.576039296638394]
[DEBUG] After calculating abs_rel_change and volume_impacted
[DEBUG] Sample abs_rel_change: [16.227387138030817, 1.73315183080808, 9.179282180133509, 6.456341805367642, 1.988686799195942, 11.925564506978322, 17.83835616438357, 10.576039296638394]
[DEBUG] Sample volume_impacted: [1136.2416474049178, 12.201388888888882, 87.47855917667233, 2953.84093937375, 100.09060660353175, 150.14285714285708, 65.11000000000003, 52.77443609022558]
[DEBUG] After filtering (abs_rel_change>10 OR volume_impacted>30): 7 rows
[DEBUG] Significant business units for RTE: ['FJ', 'CF', 'TZ', 'YE', 'TO', 'TV', 'TK']

[DEBUG Week vs Prev Week - Level 2 BU] Processing reporting cluster: WL
[DEBUG] week_prev_df shape: (44, 23)
[DEBUG] week_prev_df reporting_cluster values: ['INTL-startup' 'Overall' 'RTE' 'INTL-growing' 'US-HF' 'HF-NA'
 'INTL-mature' 'HF-INTL' 'WL' 'HF-TOTAL' 'bu_level']
[DEBUG] week_prev_df business_unit sample: ['Null', 'Null', 'Null', 'Null', 'Null', 'Null', 'Null', 'Null', 'Null', 'Null']
[DEBUG] Business units in WL from country_mapping_df: 8 (['AO', 'CG', 'CK', 'ER', 'GN', 'GQ', 'KN', 'MR']...)
[DEBUG] level2_bu_rows count after filtering by business_unit.isin(rc_bu): 8
[DEBUG] level2_bu_rows reporting_cluster values: ['bu_level']
[DEBUG] level2_bu_rows business_unit values: ['GN' 'ER' 'CK' 'KN' 'GQ' 'AO' 'MR' 'CG']
[DEBUG] level2_bu_rows sample relative_change_pct: [10.940779752040294, 12.00758681062153, 18.351062426589053, 2.494264797295429, 4.312668463611864, 4.209097905780373, 10.177831593459672, 10.1011555660975]
[DEBUG] After calculating abs_rel_change and volume_impacted
[DEBUG] Sample abs_rel_change: [10.940779752040294, 12.00758681062153, 18.351062426589053, 2.494264797295429, 4.312668463611864, 4.209097905780373, 10.177831593459672, 10.1011555660975]
[DEBUG] Sample volume_impacted: [327.78576137112725, 572.5217391304345, 881.9520602218699, 134.14156079854817, 2.285714285714288, 32.83096366508691, 817.5852119026154, 437.5820591233437]
[DEBUG] After filtering (abs_rel_change>10 OR volume_impacted>30): 7 rows
[DEBUG] Significant business units for WL: ['CK', 'MR', 'ER', 'CG', 'GN', 'KN', 'AO']

[DEBUG build_callout_for_metric] Starting Long Term Impact for: 1_Activation (Paid + Referrals) - 1_Checkout Funnel - 1_PaymentPageVisitToSuccess
[DEBUG] STEP 1 - Input quarter_prev_df shape: (44, 23)
[DEBUG] STEP 1 - Input quarter_prev_df reporting_cluster values: ['HF-NA' 'WL' 'INTL-startup' 'HF-TOTAL' 'RTE' 'INTL-growing' 'US-HF'
 'INTL-mature' 'Overall' 'HF-INTL' 'bu_level']
[DEBUG] STEP 1 - bu_level rows in input: 34
[DEBUG] STEP 2 - After data type normalization, df_metric shape: (44, 23)
[DEBUG] STEP 2 - reporting_cluster distribution:
bu_level        34
HF-NA            1
WL               1
INTL-startup     1
HF-TOTAL         1
RTE              1
INTL-growing     1
US-HF            1
INTL-mature      1
Overall          1
HF-INTL          1
Name: reporting_cluster, dtype: int64
[DEBUG] STEP 3 - Overall rows count: 1
[DEBUG] STEP 3 - Overall relative_change_pct: 5.38%
[DEBUG] STEP 4 - bu_level_rows count: 34
[DEBUG] STEP 4 - bu_level_rows dimension_name values: ['_Overall']
[DEBUG] STEP 4 - Sample business units: ['FR', 'AT', 'NL', 'NZ', 'US', 'BE', 'ES', 'CA', 'DK', 'TZ']
[DEBUG] STEP 4 - Sample relative_change_pct values: [7.273658690981051, 9.611133539136576, 20.57101005075078, 1.0290969722604506, 2.136956103508311, 15.118296155861147, 1.4218497742272045, 7.983763699481505, 12.608456236208433, -7.992516716220075]
[DEBUG] STEP 5 - Processing reporting clusters to find business units...
[DEBUG] STEP 5.HF-NA - Business units in HF-NA: 2 (['CA', 'US']...)
[DEBUG] STEP 5.HF-NA - After filtering by business_unit.isin(rc_bu): 2 rows
[DEBUG] STEP 5.HF-NA - After calculating abs_rel_change and volume_impacted
[DEBUG] STEP 5.HF-NA - Sample abs_rel_change: [2.136956103508311, 7.983763699481505]
[DEBUG] STEP 5.HF-NA - Sample volume_impacted: [14366.029318811181, 18835.53483272775]
[DEBUG] STEP 5.HF-NA - After filtering (abs_rel_change>10 OR volume_impacted>30): 2 rows
[DEBUG] STEP 5.HF-NA - Significant business units: ['CA', 'US']
[DEBUG] STEP 5.HF-INTL - Business units in HF-INTL: 16 (['AT', 'AU', 'BE', 'CH', 'DE']...)
[DEBUG] STEP 5.HF-INTL - After filtering by business_unit.isin(rc_bu): 16 rows
[DEBUG] STEP 5.HF-INTL - After calculating abs_rel_change and volume_impacted
[DEBUG] STEP 5.HF-INTL - Sample abs_rel_change: [7.273658690981051, 9.611133539136576, 20.57101005075078, 1.0290969722604506, 15.118296155861147]
[DEBUG] STEP 5.HF-INTL - Sample volume_impacted: [25992.637541981516, 1890.8944124897298, 9254.074581430745, 262.19332659251756, 6842.994389027431]
[DEBUG] STEP 5.HF-INTL - After filtering (abs_rel_change>10 OR volume_impacted>30): 16 rows
[DEBUG] STEP 5.HF-INTL - Significant business units: ['FR', 'GB', 'DE', 'IT', 'NL', 'SE', 'IE', 'BE', 'NO', 'DK', 'AU', 'AT', 'CH', 'ES', 'NZ', 'LU']
[DEBUG] STEP 5.RTE - Business units in RTE: 8 (['CF', 'FJ', 'TO', 'TT', 'YE']...)
[DEBUG] STEP 5.RTE - After filtering by business_unit.isin(rc_bu): 8 rows
[DEBUG] STEP 5.RTE - After calculating abs_rel_change and volume_impacted
[DEBUG] STEP 5.RTE - Sample abs_rel_change: [7.992516716220075, 4.702076394118909, 12.981714707172017, 14.887066359987584, 6.071891638390029]
[DEBUG] STEP 5.RTE - Sample volume_impacted: [2173.484995808887, 5074.057657657656, 1410.9825715225265, 2283.2293676312956, 460.6744186046515]
[DEBUG] STEP 5.RTE - After filtering (abs_rel_change>10 OR volume_impacted>30): 8 rows
[DEBUG] STEP 5.RTE - Significant business units: ['FJ', 'YE', 'TO', 'TT', 'TZ', 'TK', 'CF', 'TV']
[DEBUG] STEP 5.WL - Business units in WL: 8 (['AO', 'CG', 'CK', 'ER', 'GN']...)
[DEBUG] STEP 5.WL - After filtering by business_unit.isin(rc_bu): 8 rows
[DEBUG] STEP 5.WL - After calculating abs_rel_change and volume_impacted
[DEBUG] STEP 5.WL - Sample abs_rel_change: [2.463278515686031, 13.51411283509166, 3.361200144820982, 13.352756460038687, 9.34308697569258]
[DEBUG] STEP 5.WL - Sample volume_impacted: [2838.2634041289157, 13309.10374338332, 5293.688556084357, 2479.7404021937846, 6892.30183109866]
[DEBUG] STEP 5.WL - After filtering (abs_rel_change>10 OR volume_impacted>30): 7 rows
[DEBUG] STEP 5.WL - Significant business units: ['CG', 'CK', 'ER', 'MR', 'GN', 'KN', 'AO']
[DEBUG] STEP 6 - Total significant business units collected: 33
[DEBUG] STEP 6 - Significant business units: ['CA', 'US', 'FR', 'GB', 'DE', 'IT', 'NL', 'SE', 'IE', 'BE', 'NO', 'DK', 'AU', 'AT', 'CH', 'ES', 'NZ', 'LU', 'FJ', 'YE', 'TO', 'TT', 'TZ', 'TK', 'CF', 'TV', 'CG', 'CK', 'ER', 'MR', 'GN', 'KN', 'AO']
[DEBUG] STEP 7 - has_significant_overall: False, has_significant_bu: True
