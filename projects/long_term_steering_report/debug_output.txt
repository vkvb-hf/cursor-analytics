   [DEBUG YOY] Building query for year-over-year comparison...
   [DEBUG YOY] Query built for date_value: 2025-W45
   [DEBUG YOY] Raw query returned 1279 rows
   [DEBUG YOY] Columns in week_yoy_data: ['date_value', 'date_granularity', 'comparison_type', 'comparison_label', 'reporting_cluster', 'business_unit', 'metric_final_name', 'dimension_name', 'dimension_value', 'flag_more_is_good', 'flag_is_p0', 'metric_type', 'current_metric_value_numerator', 'current_metric_value_denominator', 'prev_metric_value_numerator', 'prev_metric_value_denominator']
   [DEBUG YOY] Rows with NULL prev_metric_value_numerator: 0
   [DEBUG YOY] Rows with NULL prev_metric_value_denominator: 0
   [DEBUG YOY] Sample row:
     - reporting_cluster: Overall
     - business_unit: Null
     - metric_final_name: 3_Active - 1_1_Overall Total Box Candidates - 2_Pr...
     - current_metric_value_numerator: 1912661.0
     - current_metric_value_denominator: 2081663.0
     - prev_metric_value_numerator: 2153466.0
     - prev_metric_value_denominator: 2342794.0
   [DEBUG YOY] reporting_cluster distribution:
   [DEBUG YOY] bu_level rows: 578
   [DEBUG YOY] Overall rows: 71
   [DEBUG YOY] AFTER PROCESSING - week_yoy_processed shape: (1279, 23)
   [DEBUG YOY] AFTER PROCESSING - reporting_cluster distribution:
bu_level        578
Overall          71
WL               71
INTL-mature      71
HF-INTL          71
HF-TOTAL         71
INTL-growing     70
RTE              70
HF-NA            69
INTL-startup     69
US-HF            68
Name: reporting_cluster, dtype: int64
   [DEBUG YOY] AFTER PROCESSING - Overall rows with _Overall dimension: 17
   [DEBUG YOY] Sample Overall row relative_change_pct: -0.040594784129497775
   [DEBUG YOY] Sample Overall row prev_ratio: 0.9191870902862138
   [DEBUG YOY] Sample Overall row current_ratio: 0.9188139482711659
   [DEBUG] Building queries for current and previous quarters...
   [DEBUG] data_current count: 1281
   [DEBUG] data_prev count: 1282
   [DEBUG] BEFORE JOIN - Checking reporting_cluster distribution:
   [DEBUG] data_current reporting_cluster distribution:
   [DEBUG] data_prev reporting_cluster distribution:
   [DEBUG] BEFORE JOIN - bu_level rows in data_current: 578
   [DEBUG] BEFORE JOIN - bu_level rows in data_prev: 578
   [DEBUG] Sample bu_level row in data_current (IT):
     - business_unit: IT
     - metric_final_name: 1_Activation (Paid + Referrals) - 1_Checkout Funnel - 1_PaymentPageVisitToSuccess
     - dimension_name: _Overall
     - dimension_value: None
     - current_metric_value_numerator: 7053.0
     - current_metric_value_denominator: 25517.0
   [DEBUG] Sample bu_level row in data_prev (IT):
     - business_unit: IT
     - metric_final_name: 1_Activation (Paid + Referrals) - 1_Checkout Funnel - 1_PaymentPageVisitToSuccess
     - dimension_name: _Overall
     - dimension_value: None
     - flag_more_is_good: TRUE
     - flag_is_p0: TRUE
     - metric_type: ratio
     - current_metric_value_numerator: 3099.0
     - current_metric_value_denominator: 15407.0
   [DEBUG] Comparing join keys for IT:
     - business_unit match: True
     - metric_final_name match: True
     - dimension_name match: True
     - dimension_value match: True (current: None, prev: None)
     - flag_more_is_good match: True
     - flag_is_p0 match: True
     - metric_type match: True
   [DEBUG] BEFORE JOIN - data_current_clean count: 1281
   [DEBUG] BEFORE JOIN - data_prev_selected count: 1282
   [DEBUG] Performing LEFT JOIN on columns: ['reporting_cluster', 'business_unit', 'metric_final_name', 'dimension_name', 'dimension_value', 'flag_more_is_good', 'flag_is_p0', 'metric_type']
   [DEBUG] AFTER JOIN - data_combined count: 1281
   [DEBUG] AFTER JOIN - bu_level rows in data_combined: 578
   [DEBUG] BEFORE fillna - bu_level rows with NULL prev_metric_value_numerator: 0
   [DEBUG] BEFORE fillna - bu_level rows with NULL prev_metric_value_denominator: 0
   [DEBUG] Sample bu_level row (IT) before fillna:
     - current_metric_value_numerator: 52727.0
     - current_metric_value_denominator: 60269.0
     - prev_metric_value_numerator: 42918.0
     - prev_metric_value_denominator: 48902.0
     - business_unit: IT
     - metric_final_name: 3_Active - 1_1_Overall Total Box Candidates - 2_PreDunningAR
   [DEBUG] AFTER PROCESSING - bu_level rows in quarter_prev_processed: 578
   [DEBUG] AFTER PROCESSING - reporting_cluster distribution:
bu_level        578
INTL-mature      71
HF-INTL          71
Overall          71
WL               71
HF-TOTAL         71
RTE              70
INTL-growing     70
HF-NA            70
INTL-startup     69
US-HF            69
Name: reporting_cluster, dtype: int64
   [DEBUG] AFTER PROCESSING - test_metric_df count: 44
   [DEBUG] AFTER PROCESSING - bu_level rows for 1_Activation (Paid + Referrals) - 1_Checkout Funnel - 1_PaymentPageVisitToSuccess: 34
   [DEBUG] Sample bu_level business units: ['FR', 'AT', 'NL', 'NZ', 'US', 'BE', 'ES', 'CA', 'DK', 'TZ']

================================================================================
[DEBUG METRIC FILTERING] Processing metric: 1_Activation (Paid + Referrals) - 1_Checkout Funnel - 1_PaymentPageVisitToSuccess
================================================================================
[DEBUG] BEFORE FILTERING - quarter_prev_processed shape: (1281, 23)
[DEBUG] BEFORE FILTERING - Unique metric_final_name values (first 10):
[DEBUG] BEFORE FILTERING - Checking if our metric exists in quarter_prev_processed:
[DEBUG] BEFORE FILTERING - Metric exists: True
[DEBUG] BEFORE FILTERING - Matching rows count: 44
[DEBUG] BEFORE FILTERING - reporting_cluster distribution in matching rows:
[DEBUG] BEFORE FILTERING - bu_level rows in matching: 34
[DEBUG YOY FILTERING] Before filtering for 1_Activation (Paid + Referrals) - 1_Checkout Funnel - 1_PaymentPageVisitToSuccess:
[DEBUG YOY FILTERING] week_yoy_processed shape: (1279, 23)
[DEBUG YOY FILTERING] Unique metric_final_name values (first 5):
[DEBUG YOY FILTERING] Metric exists in week_yoy_processed: True
[DEBUG YOY FILTERING] Matching rows count: 44
[DEBUG YOY FILTERING] reporting_cluster distribution:
[DEBUG YOY FILTERING] After filtering:
[DEBUG YOY FILTERING] week_yoy_metric shape: (44, 23)
[DEBUG YOY FILTERING] reporting_cluster values: ['INTL-startup' 'Overall' 'US-HF' 'INTL-mature' 'HF-NA' 'HF-INTL' 'RTE'
 'HF-TOTAL' 'WL' 'INTL-growing' 'bu_level']
[DEBUG YOY FILTERING] Overall rows with _Overall dimension: 1
[DEBUG YOY FILTERING] Sample relative_change_pct: -8.369636549881387
[DEBUG] AFTER FILTERING - quarter_prev_metric:
[DEBUG] AFTER FILTERING - quarter_prev_metric shape: (44, 23)
[DEBUG] AFTER FILTERING - reporting_cluster values: ['HF-NA' 'WL' 'INTL-startup' 'HF-TOTAL' 'RTE' 'INTL-growing' 'US-HF'
 'INTL-mature' 'Overall' 'HF-INTL' 'bu_level']
[DEBUG] AFTER FILTERING - reporting_cluster distribution:
[DEBUG] AFTER FILTERING - bu_level rows in quarter_prev_metric: 34
[DEBUG] AFTER FILTERING - Sample business units: ['FR', 'AT', 'NL', 'NZ', 'US', 'BE', 'ES', 'CA', 'DK', 'TZ']
[DEBUG] AFTER FILTERING - Sample relative_change_pct: [7.273658690981051, 9.611133539136576, 20.57101005075078, 1.0290969722604506, 2.136956103508311, 15.118296155861147, 1.4218497742272045, 7.983763699481505, 12.608456236208433, -7.992516716220075]

[DEBUG build_callout_for_metric] Starting Long Term Impact for: 1_Activation (Paid + Referrals) - 1_Checkout Funnel - 1_PaymentPageVisitToSuccess
[DEBUG] STEP 1 - Input quarter_prev_df shape: (44, 23)
[DEBUG] STEP 1 - Input quarter_prev_df reporting_cluster values: ['HF-NA' 'WL' 'INTL-startup' 'HF-TOTAL' 'RTE' 'INTL-growing' 'US-HF'
 'INTL-mature' 'Overall' 'HF-INTL' 'bu_level']
[DEBUG] STEP 1 - bu_level rows in input: 34
[DEBUG] STEP 2 - After data type normalization, df_metric shape: (44, 23)
[DEBUG] STEP 2 - reporting_cluster distribution:
bu_level        34
HF-NA            1
WL               1
INTL-startup     1
HF-TOTAL         1
RTE              1
INTL-growing     1
US-HF            1
INTL-mature      1
Overall          1
HF-INTL          1
Name: reporting_cluster, dtype: int64
[DEBUG] STEP 3 - Overall rows count: 1
[DEBUG] STEP 3 - Overall relative_change_pct: 5.38%
[DEBUG] STEP 4 - bu_level_rows count: 34
[DEBUG] STEP 4 - bu_level_rows dimension_name values: ['_Overall']
[DEBUG] STEP 4 - Sample business units: ['FR', 'AT', 'NL', 'NZ', 'US', 'BE', 'ES', 'CA', 'DK', 'TZ']
[DEBUG] STEP 4 - Sample relative_change_pct values: [7.273658690981051, 9.611133539136576, 20.57101005075078, 1.0290969722604506, 2.136956103508311, 15.118296155861147, 1.4218497742272045, 7.983763699481505, 12.608456236208433, -7.992516716220075]
[DEBUG] STEP 5 - Processing reporting clusters to find business units...
[DEBUG] STEP 5.HF-NA - Business units in HF-NA: 2 (['CA', 'US']...)
[DEBUG] STEP 5.HF-NA - After filtering by business_unit.isin(rc_bu): 2 rows
[DEBUG] STEP 5.HF-NA - After calculating abs_rel_change and volume_impacted
[DEBUG] STEP 5.HF-NA - Sample abs_rel_change: [2.136956103508311, 7.983763699481505]
[DEBUG] STEP 5.HF-NA - Sample volume_impacted: [14366.029318811181, 18835.53483272775]
[DEBUG] STEP 5.HF-NA - After filtering (abs_rel_change>10 OR volume_impacted>30): 2 rows
[DEBUG] STEP 5.HF-NA - Significant business units: ['CA', 'US']
[DEBUG] STEP 5.HF-INTL - Business units in HF-INTL: 16 (['AT', 'AU', 'BE', 'CH', 'DE']...)
[DEBUG] STEP 5.HF-INTL - After filtering by business_unit.isin(rc_bu): 16 rows
[DEBUG] STEP 5.HF-INTL - After calculating abs_rel_change and volume_impacted
[DEBUG] STEP 5.HF-INTL - Sample abs_rel_change: [7.273658690981051, 9.611133539136576, 20.57101005075078, 1.0290969722604506, 15.118296155861147]
[DEBUG] STEP 5.HF-INTL - Sample volume_impacted: [25992.637541981516, 1890.8944124897298, 9254.074581430745, 262.19332659251756, 6842.994389027431]
[DEBUG] STEP 5.HF-INTL - After filtering (abs_rel_change>10 OR volume_impacted>30): 16 rows
[DEBUG] STEP 5.HF-INTL - Significant business units: ['FR', 'GB', 'DE', 'IT', 'NL', 'SE', 'IE', 'BE', 'NO', 'DK', 'AU', 'AT', 'CH', 'ES', 'NZ', 'LU']
[DEBUG] STEP 5.US-HF - Business units in US-HF: 0 ([]...)
[DEBUG] STEP 5.US-HF - After filtering by business_unit.isin(rc_bu): 0 rows
[DEBUG] STEP 5.RTE - Business units in RTE: 8 (['CF', 'FJ', 'TO', 'TT', 'YE']...)
[DEBUG] STEP 5.RTE - After filtering by business_unit.isin(rc_bu): 8 rows
[DEBUG] STEP 5.RTE - After calculating abs_rel_change and volume_impacted
[DEBUG] STEP 5.RTE - Sample abs_rel_change: [7.992516716220075, 4.702076394118909, 12.981714707172017, 14.887066359987584, 6.071891638390029]
[DEBUG] STEP 5.RTE - Sample volume_impacted: [2173.484995808887, 5074.057657657656, 1410.9825715225265, 2283.2293676312956, 460.6744186046515]
[DEBUG] STEP 5.RTE - After filtering (abs_rel_change>10 OR volume_impacted>30): 8 rows
[DEBUG] STEP 5.RTE - Significant business units: ['FJ', 'YE', 'TO', 'TT', 'TZ', 'TK', 'CF', 'TV']
[DEBUG] STEP 5.WL - Business units in WL: 8 (['AO', 'CG', 'CK', 'ER', 'GN']...)
[DEBUG] STEP 5.WL - After filtering by business_unit.isin(rc_bu): 8 rows
[DEBUG] STEP 5.WL - After calculating abs_rel_change and volume_impacted
[DEBUG] STEP 5.WL - Sample abs_rel_change: [2.463278515686031, 13.51411283509166, 3.361200144820982, 13.352756460038687, 9.34308697569258]
[DEBUG] STEP 5.WL - Sample volume_impacted: [2838.2634041289157, 13309.10374338332, 5293.688556084357, 2479.7404021937846, 6892.30183109866]
[DEBUG] STEP 5.WL - After filtering (abs_rel_change>10 OR volume_impacted>30): 7 rows
[DEBUG] STEP 5.WL - Significant business units: ['CG', 'CK', 'ER', 'MR', 'GN', 'KN', 'AO']
[DEBUG] STEP 6 - Total significant business units collected: 33
[DEBUG] STEP 6 - Significant business units: ['CA', 'US', 'FR', 'GB', 'DE', 'IT', 'NL', 'SE', 'IE', 'BE', 'NO', 'DK', 'AU', 'AT', 'CH', 'ES', 'NZ', 'LU', 'FJ', 'YE', 'TO', 'TT', 'TZ', 'TK', 'CF', 'TV', 'CG', 'CK', 'ER', 'MR', 'GN', 'KN', 'AO']
[DEBUG] STEP 7 - has_significant_overall: False, has_significant_bu: True, has_significant_dims: False

[DEBUG YOY - build_callout_for_metric] Processing metric: 1_Activation (Paid + Referrals) - 1_Checkout Funnel - 1_PaymentPageVisitToSuccess
[DEBUG YOY] week_yoy_df is None: False
[DEBUG YOY] week_yoy_df.empty: False
[DEBUG YOY] week_yoy_df.shape: (44, 23)
[DEBUG YOY] week_yoy_df reporting_cluster values: ['INTL-startup' 'Overall' 'US-HF' 'INTL-mature' 'HF-NA' 'HF-INTL' 'RTE'
 'HF-TOTAL' 'WL' 'INTL-growing' 'bu_level']
[DEBUG YOY] week_yoy_df dimension_name values: ['_Overall']
[DEBUG YOY] overall_yoy.empty: False
[DEBUG YOY] overall_yoy.shape: (1, 23)
[DEBUG YOY] overall_yoy.iloc[0] relative_change_pct: -8.369636549881387
[DEBUG YOY] bu_level_rows_yoy count: 34
[DEBUG YOY] HF-NA - Significant business units: 2
[DEBUG YOY] HF-INTL - Significant business units: 15
[DEBUG YOY] RTE - Significant business units: 8
[DEBUG YOY] WL - Significant business units: 7
[DEBUG YOY] Total significant business units: 32
[DEBUG YOY] Total significant dimensions: 0
